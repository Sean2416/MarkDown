# 付款流程

1. ## Client發起付款請求

   1. ##### Client呼叫 API:  payment/program/member/{bank}/QuickPayService/SendToBank

      - ###### url:  {controller}/{program}/{member}/{bank}/{QuickPayService}/{SendToBank} 

      - ###### 對應PaymentController.Index

      - ###### bank: 支付方式

   2. ##### 依據指定支付方式取得支付設定內容

      - ###### 系統在啟動時會從資料庫內取得相關支付設定

        1. ###### 先至MySQL 資料庫:payment 資料表: cfg_pay_platform取得所有設定資料

        2. ###### 若MySQL沒有資料會再至 SQL Server 資料庫:muchnewdb 資料表TutorDefinition.dbo.CfgPayPlatform查詢

      - ###### 依據bank欄位取得對應的設定值

        - ###### CacheFactory.CfgPayPlatform.FirstOrDefault(a => a.EnumCode == RouteData.Values["bank"].ToString())

      - ###### WebSite對應國別

        - ###### T: 台灣
        - ###### C: 大陸
        - ###### J: 日文

   3. ##### 檢察訂單內容

      - ###### PaymentVerifyHelper.CheckOrderInfo(paymentBankModel, lng)

      - ###### PaymentVerifyHelper.CheckSerialNumberAndPeriod(serialNumbers, lng)

   4. ##### 透過付款單序號取得訂單明細

      - ###### 先至MySQL取資料 (ContractRepository.GetClientContractInfoFromMysql)

        - ###### 合約包含主檔(付款紀錄表)及明細檔(訂單明細表)，透過client_payment_record.id 與 client_payment_detail.payrecord_sn串聯

      - ###### 若MySQL無資料，則至SQL Server取得 (ContractRepository.GetClientContractInfoFromSql)

   5. ##### 檢查合約內容

      1. ###### 判斷合約是否為null 或 是否合法(Valid)

      2. ###### 若沒有選擇幣別，則比較缴款金额是否相同

      3. ###### 若有填入幣別，則比較原幣金額(CurrencyAmount)

      4. ###### 判斷訂單是否已經付款過

      5. ###### 判斷付款方式是否包含在設定值(//23.台湾在线刷卡，34.在线支付，72.超商)

      6. ###### 錯誤訊息依據步驟2內的WebSite(T: 台灣, C: 大陸, J:日本)至PaymentVerifyHelper.GetDescription 取得對應訊息及語系

   6. ##### 點擊付款處理

      - ###### InsertToHiTrustRecordAllAndReturnSN(histrustRecordAll);

      - ###### 新增點擊支付紀錄: 

        - ###### MySQL資料至`hitrust_record_all` 並取得回傳sn序號

        - ###### 新增SQL Server資料`hitrust_record_all`

      - 更新訂單明細

        - ###### 更新MYSQL資料庫`client_payment_detail` id= PaymentDetailSn

        - ###### 更新SQL Server資料庫`client_payment_detail` sn= PaymentDetailSn

   7. ##### 呼叫28202取得支付設定內容

      

2. ## 系統至28202進行訂單處理

   1. ##### 建立支付請求表

      - ###### ServiceFactory.PayRequestService.AddPayRequest(requestData);

      - ###### MySQL 資料庫:payment 資料表: ms_payment_pay_request

      - ###### 並回傳ID

   2. ##### 建立支付歷史紀錄表

      - ###### ServiceFactory.PayHistoryService.Add(requestData, requestId);

      - ###### MySQL 資料庫:payment 資料表: ms_payment_pay_history

      - ###### 透過`requestID`與ms_payment_pay_request關聯

      - ###### PKey: serialNumber(自動增長序號)

      - ###### 如果OrderId欄位為空時，將serialNumber塞入OrderId欄位

      - ###### 回傳serialNumber

   3. ##### 取得支付設定檔

      - ###### 至MySQL資料庫 ms_payment_pay_config 

      - ###### 依據支付代號 `bank`取得設定檔內容

   4. ##### 驗證支付設定內容

      - ###### PayBankFactory.PaymentToBankService.Verify(requestData)

      - ###### 透過Factory的方式取得支付對應的涵式庫

      - ###### 路徑: .\TutorGroup.Payment.BankInterface\{支付方式}\Helps.cs

   5. ##### 建立支付回傳內容

      - ###### PayBankFactory.PaymentToBankService.BankRequest(requestData)

      - ###### 路徑: .\TutorGroup.Payment.BankInterface\{支付方式}\Helps.cs

      - ###### 依據步驟3 之設定檔(config_xml欄位)及各支付平台規範，建立回傳導頁內容

      - ###### config_xml: 為支付相關參數

        

3. ## 28202透過28203取得支付設定

   1. ##### 取得步驟2回傳的設定值

   2. ##### 回傳前端開始進行支付動作

   

4. ## 支付完成，呼叫28203進行Call back處理

   1. #### 金流支付完成後會呼叫28203指定URL(EX./PaymentPlatform/XXX/NotifyMsg)

      - ##### API路徑位置設定於Request內(ex.綠界route設定 .\TutorGroup.Payment.API\Models\ECPayNotifyRequest.cs)

      - ##### 支付Callback路徑在`.\TutorGroup.Payment.API\Payment\XXX.cs`(依據各支付平台切分)

   2. ### 通用流程

      1. ##### 回傳資料驗證(依據各支付平台)

         1. ##### 藍新

            1. ###### 判斷回傳的加密後`TradeInfo`是否與`TradeSha`相同

            2. ###### 將TradeInfor解密後取回資料

            3. ###### 判斷Status 是否為 Success

         2. ##### 綠界

            1. ##### 驗證FormData是否重複

               - ###### 透過系統常數儲存處理過的資料，並每次都進行判斷是否已經存在相同數據(避免支付成功重複發送)

               - ###### 系統設定站存10筆key值??

            2. ##### 回傳資料驗證

               - ###### 驗證`checkMacValue`與系統產生的`checkMacValue`(透過回傳的Key-Value，透過系統邏輯產生checkMacValue)

      2. ##### 新增支付Callback紀錄 `ServiceFactory.PayResponseService.Add`

         1. ##### 取得原始訂單資料的`SerialNumber`

            - ###### MySQL 資料庫:payment 資料表: ms_payment_pay_history  

            - ```sql
              select id ID,request_id RequestID,response_id ResponseID,success Success,bank Bank,message Message,
              order_sn OrderSn,serial_number SerialNumber,amount Amount,result_amount ResultAmount,request_date RequestDate,
              response_date ResponseDate,installment_times InstallmentTimes,order_id OrderId,app_id AppId,out_trade_no OutTradeNo,property_ex PropertyEx from ms_payment_pay_history 
              where order_id=@orderId; 
              ```

         2. ##### 新增支付Callback紀錄

            - ###### MySQL 資料庫:payment 資料表: ms_payment_pay_response

      3. ##### 透過SerialNumber取回支付紀錄 ServiceFactory.PayHistoryService.GetEfHistoryByOrderId(orderId);

      4. ##### 判斷history是否已經處理完成，若完成則直接回傳 

         - ###### 判斷交易紀錄的Success狀態、訊息、金額

      5. ##### 更新交易紀錄(`ServiceFactory.PayHistoryService.UpdatePayHistory(data, g)`)

         - ###### 更新資料庫payment 資料表: ms_payment_pay_history 

         - ###### 更新欄位Success、Message、ResultAmount、ResponseDate

         - ###### 依據serial_number找尋特定紀錄

      6. ##### 送通知到設定檔位置` HttpWebRequestHelper.SendResultToMerchantSite(data)`

         - ###### 預設Call 28302 Notify API `/api/Notify`

           

5. ## 28202收到28203通知回傳

   1. #####  檢查是否先訂單

      - ###### MySQL 資料庫:payment 資料表: order_tp

      - ###### 透過SerialNumber查詢

   2. ##### 處理付款資料 

      - ######  HandlerOrderAmount( notifyService, payResultMsg.PayDate, ref transactionType );

      - ###### 取得訂單明細表(MySQL) 資料庫payment 資料表: client_payment_detail

      - ###### 依據訂單內容進行資料處理

        


## 各支付平台回傳導頁設定

### 藍新

```C#
//TradeInfo內容
{
    sort.Add("MerchantID", _mch_id); //商店代號 必填
    sort.Add("RespondType", "JSON"); // 回傳格式必填 JSON/String
    sort.Add("TimeStamp", timeSpan.ToString()); //時間標記 必填
    sort.Add("Version", "1.4");//串接程式版本
    sort.Add("MerchantOrderNo", orderId);//訂單編號 必填,30字以內且同一個特店不可重複
    sort.Add("Amt", amt); //金額必填
    sort.Add("ItemDesc", prodName);// 商品資訊 必填
    sort.Add("LoginType", "0"); //是否需要登入藍新會員
    sort.Add("ReturnURL", _returnUrl);//支付完成後導頁網址,若為空值則停留在藍新結果頁面
    sort.Add("NotifyURL", _notifyUrl);//支付成功後通知網址
    sort.Add("UNIONPAY", "1"); //信用卡銀聯卡啟用
    sort.Add("LangType", _locale); //語系 ex. en,zh-tw,jp
    if (period <= 1)
        sort.Add("CREDIT", "1"); // 使否啟用信用卡紅利支付
    else
        sort.Add("InstFlag", period.ToString());   //信用卡分期啟用，利用,號分開(3,6,12) 
}

sort.Add("TradeInfo", EncryptAes(sort)); //交易資料 AES加密必填(依據商店的key及iv進行加密)
sort.Add("TradeSha", Signature(sort["TradeInfo"])); //交易資料進行SHA256加密(依據商店的key及iv進行加密)
```

### 綠界

- ```C#
  {
      //-----
  	var dict = new SortedDictionary<string, string>
      {
          //特店編號必填
          {"MerchantID", uniqueParameter.MerchantID},
          //特店訂單編號必填
          {"MerchantTradeNo", data.OrderId},
          //特店交易時間必填
          {"MerchantTradeDate", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss")},
          //交易類型 必填
          {"PaymentType", _config.PaymentType},
          //交易金額 必填
          {"TotalAmount", data.Amount.ToString()},
          //交易描述 必填
          {"TradeDesc", data.TradeDesc},
          //商品名稱 必填
          {"ItemName", data.ProductName},
          //付款完成通知回傳網址 必填
          {"ReturnURL", _config.ReturnURL},
          /*
          選擇預設付款方式
              Credit：信用卡及銀聯卡(需申請開通)
              WebATM：網路ATM
              ATM：自動櫃員機
              CVS：超商代碼
              BARCODE：超商條碼
              ApplePay: Apple Pay(僅支援手機支付)
              ALL：不指定付款方式，由綠界顯示付款方式選擇頁面。
          */
          {"ChoosePayment", _config.ChoosePayment},
          //{ "ClientBackURL", _config.ClientBackURL },
          //改为由调用方传入地址
          {"ClientBackURL", data.ResultURL},
          {"CreditInstallment", data.InstallmentTimes > 1 ? data.InstallmentTimes.ToString() : string.Empty},
          {"NeedExtraPaidInfo", _config.NeedExtraPaidInfo},
          //EncryptType  固定1
          {"EncryptType", "1"},
          {"Language", Language}
      };
  
      var sb = new StringBuilder();
      
      //GateWay: 綠界API位置
      sb.Append($"<form id=\"pay_form\" action=\"{_config.GateWay}\" method=\"post\">");
  
      //將上面設定的欄位帶入form data中,在Post時一併傳遞
      foreach (var item in dict)
      {
          sb.Append($"<input name=\"{item.Key}\" type=\"hidden\" value=\"{item.Value}\"/>");
      }
      // CheckMacValue 檢查碼 必填
      sb.Append($"<input name=\"CheckMacValue\" type=\"hidden\" value=\"{Signature(dict)}\"/>");
      sb.Append("</form>");
      sb.Append("<script language=\"javascript\">window.onload = function() {document.getElementById(\"pay_form\").submit();}</script>");
      return sb.ToString();
  }
  
  public string Signature(SortedDictionary<string, string> data)
  {
      var hashKey = _config.HashKey;
      var hashIv = _config.HashIV;
      var midName = "MerchantID";
  
      //绿界24期用专用的商户号
      if (data.ContainsKey(midName) && data[midName] == _config.Pay24PeriodConfig.MerchantID)
      {
          hashKey = _config.Pay24PeriodConfig.HashKey;
          hashIv = _config.Pay24PeriodConfig.HashIV;
      }
      else if ( data.ContainsKey( midName ) && data[midName] == _config.EscrowConfig.MerchantID) //綠界履約保證
      {
          hashKey = _config.EscrowConfig.HashKey;
          hashIv = _config.EscrowConfig.HashIV;
      }
  
      var text = $"HashKey={hashKey}&{string.Join("&", data.Select(a => a.Key + "=" + a.Value))}&HashIV={hashIv}";
  
      MongoLogHelper.Write($"绿界验签内容：{text}");
  
      return SHA256Crypto(text);
  }
  ```
  
  

## 資料表說明

1. ### cfg_pay_platform

   - | Field Name        | Data Type      | Description                                                  |
     | ----------------- | -------------- | ------------------------------------------------------------ |
     | id                | int(PK,AI)     |                                                              |
     | pay_mode_sn       | 付款方式       | client_payment_detail.payment_mode<br />[muchnewdb.dbo.cfg_pay_mode.sn](http://muchnewdb.dbo.cfg_pay_mode.sn/) |
     | pay_platform_code | 商店、平台id   | client_payment_detail.storeid                                |
     | pay_platform_name | 商店、平台名称 |                                                              |
     | ref_store_id      | 商店、平台id   | lient_payment_detail.storeid                                 |
     | sort              | int            |                                                              |
     | valid             | it             | 前端用以显示的值，数据逻辑不需要限定这个条件。               |
     | creator_id        | int            |                                                              |
     | created_at        | datetime       |                                                              |
     | cfg_store_sn      | nvarchar       |                                                              |
     | maximum_amount    | int            |                                                              |
     | minimal_amount    | int            |                                                              |
     | web_site          | nvarchar       |                                                              |
     | pay_type          | nvarchar       |                                                              |
     | image_name        | nvarchar       |                                                              |
     | enum_code         | nvarchar       | 英文代碼，對應API傳入bank                                    |
     | display_name      | nvarchar       |                                                              |
     | period            | nvarchar       |                                                              |
     | payment_code      | int            | 支付方式代碼(ex.41(綠界)，58(綠界分期))                      |
     | is_online_payment | int            |                                                              |
     | installment_type  | int            |                                                              |

   

2. ### ms_payment_pay_config

   | Field Name  | Data Type     | Description                                 |
   | ----------- | ------------- | ------------------------------------------- |
   | id          | int(11)       |                                             |
   | bank        | int(11)       | 支付代碼，對應cfg_pay_platform.payment_code |
   | config_type | int(11)       |                                             |
   | config_xml  | varchar(4000) | 支付方式設定內容                            |
   | code        | varchar(20)   |                                             |
   | dist        | varchar(10)   | 幣別                                        |
   | name        | varchar(20)   | 名稱                                        |
   | type        | tinyint(4)    |                                             |
   | period      | varchar(45)   | 分期設定                                    |
   | desc        | varchar(200)  | 說明                                        |
   | sort        | tinyint(4)    |                                             |
   | ex_property | varchar(2000) |                                             |

   

3. ### [其他支付相關資料表](http://tp-km.tutorabc.com/pages/viewpage.action?pageId=64247277)

   

# 訂閱流程

## 藍新訂閱制

- ##### 程式路徑: 28203.Payment.API\TutorGroup.Payment.API\Controllers\SubscriptionController.cs

- ##### API: Subscription/NewebPayAuthorize

### 

## 藍新訂閱制鑑賞期使用

- ##### 程式路徑: 28203.Payment.API\TutorGroup.Payment.API\Controllers\SubscriptionController.cs

- ##### API: Subscription/NewebPayAuthorizeByFirstFree

- ### 流程說明

  1. #### 檢查傳入參數內容

  2. ####  建立付款請求參數 (ServiceFactory.SubscriptionService.GenerateNewebPayAuthorizeParameterForFirstFree)

     1. ##### 取得付款明細(CPD) 

        - ###### 程式:_paymentRepository.SelectClientPaymentDetail(cpdSn)

        - ###### MySQL 資料庫:payment 資料表client_payment_detail

     2. ##### 處理訂閱授權資訊

        - ###### 程式: `InsertOrUpdateAuthNewebPay(subscriptionSn, merchantOrderNo, 1, productName, clientSn, email);`

        - ###### MySQL 資料庫:payment 資料表subscription_auth 

          - ###### 若無則新增訂閱資訊

        - ###### MySQL 資料庫:payment 資料表subscription_auth_newebpay (藍新訂閱授權資訊)

          - ###### 若取不到藍新訂閱授權資料，則新增一筆紀錄

          - ###### 取到則判斷金額是否相同，不同則更新訂單(金額)

     3. ##### 建立藍新支付XML

        - ##### 呼叫藍新API `MPG/mpg_gateway`

        - ##### 刷卡金額 1元

  3. #### Client 至藍新畫面進行信用卡刷卡驗證(一元)

  4. #### 用戶付款完成後，藍新Callback

     - ##### 程式路徑:  28203.Payment.API\TutorGroup.Payment.API\Controllers\SubscriptionController.cs

     - ##### API: Subscription/NewebPayAuthorizeByFirstFree 

     - ### 流程

       1. ##### 取得歷史紀錄

          - ###### MySQL 資料庫:payment 資料表client_payment_detail

          - ###### MySQL 資料庫:payment 資料表subscription_auth 

          - ###### MySQL 資料庫:payment 資料表subscription_auth_newebpay 

       2. ##### 新增訂閱付款紀錄(每次訂閱付款後，藍新回傳)

          - ###### MySQL 資料庫:payment 資料表subscription_pay_record

       3. ##### 更新資料表

          - ###### MySQL 資料庫: payment 資料表subscription_auth 

          - ###### MySQL 資料庫: payment 資料表subscription_auth_newebpay 

       4. ##### 取消試刷紀錄(step 3 驗證信用卡的一元刷卡紀錄)

          - ###### 呼叫藍新API `API/CreditCard/Cancel`進行授權取消

            - ###### 透過訂單號: merchantOrderNo

            - ###### 成功取消: 

              - ###### 新增紀錄至 MySQL 資料庫:payment 資料表subscription_refund_record

            - ###### 失敗: 發送失敗信件

- ### 參考

  - **[KM-訂閱制](http://tp-km.tutorabc.com/pages/viewpage.action?pageId=60292936&src=contextnavpagetreemode)**

  





# 發票流程

## 未開立發票查詢

- ### 程式路徑: .\FDProject\TutorGroup.FDInvoice\Controllers\ReceiptBatchOpenController.cs

- ### API路徑: ReceiptBatchOpen/GetReceiptBatchOpen

- ### 正式環境: http://tw.invoice.fdms.tutorabc.com/

- ### 流程說明

  1. ### 取得支付設定

     - ##### SQL Server 資料庫:TutorDefinition 資料表TutorDefinition.dbo.CfgPayPlatform

     - ##### 取得PayPlatFormCode、company_location欄位

  2. ### 取得未開票訂單相關資料

     - #####  batchOpenRepository.GetBatchOpenData(sDate, eDate);

     - ##### 查詢日期內訂單明細表

       - ###### SQL Server 資料庫:MuchnewDB資料表client_payment_detail

       - ###### 取得訂單明細內容

     - ##### 依據查詢出的DetailSn取得發票金額

       - ###### SQL Server 資料庫:MuchnewDB資料表client_invoice_record

     - ##### 移除已經開過發票且沒有作廢的訂單

       - ###### 針對查詢日的訂單透過`DetailSn` 對照所有發票清單

       - ###### 若發票總金額 > 0代表已經開立過發票

     - ##### 取得发票寄送信息資料

       - ###### MySQL 資料庫:payment 資料表client_invoice_info

       - ###### 透過剩餘未開票的訂單`PaymentDetailSn` 或 `ContractSn` 找尋相關資料

       - ###### 依據對應的資料調整訂單欄位內容

     - ##### 取得訂單內會員訊息

       - ###### 將訂單內會員清單透過 AP: I`http://stage.apitw.passport.tutorabc.com/web/customerKeyInfo/list` 取回會員資訊

       - ###### MemberService.GetMemberKeyInfoList(lst.Select(item => item.ClientSn).Distinct().ToList());

       - ###### 整併至訂單中

  3. ### 合併訂單

     1. ### 取得舊退費紀錄

        - ###### moneyBackRecordRepository.GetByContractSn(list.Where(d => !string.IsNullOrEmpty(d.ContractSn)) .Select(d => int.Parse(d.ContractSn)).Distinct().ToList());

        - ###### 透過訂單的ContractSn 找尋退費紀錄檔

        - ###### SQL Server 資料庫:MuchnewDB資料表client_money_back_record

     2. ### 取得退費主表

        - ###### refundRepository.GetByContractSn(list.Where(d => !string.IsNullOrEmpty(d.ContractSn)) .Select(d => int.Parse(d.ContractSn)).Distinct().ToList())

        - ###### 透過訂單的ContractSn 找尋退費紀錄檔

        - ###### SQL Server 資料庫:CNFI 資料表FDRefund

     3. ### 與訂單合併回傳

  4. ### 訂單處理

     1. ##### 檢查統一編號(InvoiceNum)

        - ###### 至商工行政平台取得統編資訊

        - ###### 判斷取回的公司名稱與发票抬头名稱是否相同

  5. ### 回傳查詢結果



## 發票開立

- #### 程式路徑: .\FDProject\TutorGroup.FDInvoice\Controllers\ReceiptBatchOpenController.cs

- #### 流程:

  1. #### 檢查發票開立日期

     1. ##### API路徑:  ReceiptBatchOpen/CheckReceiptOpenDate

     2. ##### 取得新的發票號碼

        - ##### RepositoryFactory.Common.GetReceiptNumber(Date, "1").ToString();

          - ##### 透過API: https://tw.fst-api.pay.tutorabc.com/invoice/invoice/generate_invoice_no ?invoiceDate=&invoiceType=

            - ###### Stage API: http://172.16.81.92:28233

            - ###### invoiceDate: 發票開立日期(前端傳入)

            - ###### invoiceType: 發票類型(紙本發票=1 ，電子發票 = 2)

     3. ##### 取得前一號發票資訊

        - ###### 目的: 確認新的發票日必須大於前一張發票日期

        - ###### SQL Server 資料庫:MuchnewDB資料表client_invoice_record

        - ###### 檢查取得的發票日期是否小於設定日期

  2. #### 開立發票

     1. ##### API路徑:  ReceiptBatchOpen/SetBatchOpen

     2. ##### 透過API: https://tw.fst-api.pay.tutorabc.com/invoice/invoice/add_batch_invoice進行發票開立

        - ###### Stage API: http://172.16.81.92:28233

     3. ##### 批次開票則

        

     ###### 

