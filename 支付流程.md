#  付款流程

1. ## Client發起付款請求

   1. ##### Client呼叫 API:  payment/program/member/{bank}/QuickPayService/SendToBank

      - ###### url:  {controller}/{program}/{member}/{bank}/{QuickPayService}/{SendToBank} 

      - ###### 對應PaymentController.Index

      - ###### bank: 支付方式

   2. ##### 依據指定支付方式取得支付設定內容

      - ###### 系統在啟動時會從資料庫內取得相關支付設定

        1. ###### 先至MySQL 資料庫:payment 資料表: cfg_pay_platform取得所有設定資料

        2. ###### 若MySQL沒有資料會再至 SQL Server 資料庫:muchnewdb 資料表TutorDefinition.dbo.CfgPayPlatform查詢

      - ###### 依據bank欄位取得對應的設定值

        - ###### CacheFactory.CfgPayPlatform.FirstOrDefault(a => a.EnumCode == RouteData.Values["bank"].ToString())

      - ###### WebSite對應國別

        - ###### T: 台灣
        - ###### C: 大陸
        - ###### J: 日文

   3. ##### 檢察訂單內容

      - ###### PaymentVerifyHelper.CheckOrderInfo(paymentBankModel, lng)

      - ###### PaymentVerifyHelper.CheckSerialNumberAndPeriod(serialNumbers, lng)

   4. ##### 透過付款單序號取得訂單明細

      - ###### 先至MySQL取資料 (ContractRepository.GetClientContractInfoFromMysql)

        - ###### 合約包含主檔(付款紀錄表)及明細檔(訂單明細表)，透過client_payment_record.id 與 client_payment_detail.payrecord_sn串聯

      - ###### 若MySQL無資料，則至SQL Server取得 (ContractRepository.GetClientContractInfoFromSql)

   5. ##### 檢查合約內容

      1. ###### 判斷合約是否為null 或 是否合法(Valid)

      2. ###### 若沒有選擇幣別，則比較缴款金额是否相同

      3. ###### 若有填入幣別，則比較原幣金額(CurrencyAmount)

      4. ###### 判斷訂單是否已經付款過

      5. ###### 判斷付款方式是否包含在設定值(//23.台湾在线刷卡，34.在线支付，72.超商)

      6. ###### 錯誤訊息依據步驟2內的WebSite(T: 台灣, C: 大陸, J:日本)至PaymentVerifyHelper.GetDescription 取得對應訊息及語系

   6. ##### 點擊付款處理

      - ###### InsertToHiTrustRecordAllAndReturnSN(histrustRecordAll);

      - ###### 新增點擊支付紀錄: 

        - ###### MySQL資料至`hitrust_record_all` 並取得回傳sn序號

        - ###### 新增SQL Server資料`hitrust_record_all`

      - 更新訂單明細

        - ###### 更新MYSQL資料庫`client_payment_detail` id= PaymentDetailSn

        - ###### 更新SQL Server資料庫`client_payment_detail` sn= PaymentDetailSn

   7. ##### 呼叫28203取得支付設定內容

      

2. ## 系統至28203進行訂單處理

   1. ##### 建立支付請求表

      - ###### ServiceFactory.PayRequestService.AddPayRequest(requestData);

      - ###### MySQL 資料庫:payment 資料表: ms_payment_pay_request

      - ###### 並回傳ID

   2. ##### 建立支付歷史紀錄表

      - ###### ServiceFactory.PayHistoryService.Add(requestData, requestId);

      - ###### MySQL 資料庫:payment 資料表: ms_payment_pay_history

      - ###### 透過`requestID`與ms_payment_pay_request關聯

      - ###### PKey: serialNumber(自動增長序號)

      - ###### 如果OrderId欄位為空時，將serialNumber塞入OrderId欄位

      - ###### 回傳serialNumber

   3. ##### 取得支付設定檔

      - ###### 至MySQL資料庫 ms_payment_pay_config 

      - ###### 依據支付代號 `bank`取得設定檔內容

   4. ##### 驗證支付設定內容

      - ###### PayBankFactory.PaymentToBankService.Verify(requestData)

      - ###### 透過Factory的方式取得支付對應的涵式庫

      - ###### 路徑: .\TutorGroup.Payment.BankInterface\{支付方式}\Helps.cs

   5. ##### 建立支付回傳內容

      - ###### PayBankFactory.PaymentToBankService.BankRequest(requestData)

      - ###### 路徑: .\TutorGroup.Payment.BankInterface\{支付方式}\Helps.cs

      - ###### 依據步驟3 之設定檔(config_xml欄位)及各支付平台規範，建立回傳導頁內容

      - ###### config_xml: 為支付相關參數

        

3. ## 28202透過28203取得支付設定

   1. ##### 取得步驟2回傳的設定值

   2. ##### 回傳前端開始進行支付動作

   

4. ## 支付完成，呼叫28203進行Call back處理

   1. #### 金流支付完成後會呼叫28203指定URL(EX./PaymentPlatform/XXX/NotifyMsg)

      - ##### API路徑位置設定於Request內(ex.綠界route設定 .\TutorGroup.Payment.API\Models\ECPayNotifyRequest.cs)

      - ##### 支付Callback路徑在`.\TutorGroup.Payment.API\Payment\XXX.cs`(依據各支付平台切分)

   2. ### 通用流程

      1. ##### 回傳資料驗證(依據各支付平台)

         1. ##### 藍新

            1. ###### 判斷回傳的加密後`TradeInfo`是否與`TradeSha`相同

            2. ###### 將TradeInfor解密後取回資料

            3. ###### 判斷Status 是否為 Success

         2. ##### 綠界

            1. ##### 驗證FormData是否重複

               - ###### 透過系統常數儲存處理過的資料，並每次都進行判斷是否已經存在相同數據(避免支付成功重複發送)

               - ###### 系統設定站存10筆key值??

            2. ##### 回傳資料驗證

               - ###### 驗證`checkMacValue`與系統產生的`checkMacValue`(透過回傳的Key-Value，透過系統邏輯產生checkMacValue)

      2. ##### 新增支付Callback紀錄 `ServiceFactory.PayResponseService.Add`

         1. ##### 取得原始訂單資料的`SerialNumber`

            - ###### MySQL 資料庫:payment 資料表: ms_payment_pay_history  

            - ```sql
              select id ID,request_id RequestID,response_id ResponseID,success Success,bank Bank,message Message,
              order_sn OrderSn,serial_number SerialNumber,amount Amount,result_amount ResultAmount,request_date RequestDate,
              response_date ResponseDate,installment_times InstallmentTimes,order_id OrderId,app_id AppId,out_trade_no OutTradeNo,property_ex PropertyEx from ms_payment_pay_history 
              where order_id=@orderId; 
              ```

         2. ##### 新增支付Callback紀錄

            - ###### MySQL 資料庫:payment 資料表: ms_payment_pay_response

      3. ##### 透過SerialNumber取回支付紀錄 ServiceFactory.PayHistoryService.GetEfHistoryByOrderId(orderId);

      4. ##### 判斷history是否已經處理完成，若完成則直接回傳 

         - ###### 判斷交易紀錄的Success狀態、訊息、金額

      5. ##### 更新交易紀錄(`ServiceFactory.PayHistoryService.UpdatePayHistory(data, g)`)

         - ###### 更新資料庫payment 資料表: ms_payment_pay_history 

         - ###### 更新欄位Success、Message、ResultAmount、ResponseDate

         - ###### 依據serial_number找尋特定紀錄

      6. ##### 送通知到設定檔位置` HttpWebRequestHelper.SendResultToMerchantSite(data)`

         - ###### 預設Call 28302 Notify API `/api/Notify`

           

5. ## 28202收到28203通知回傳

   1. #####  檢查是否先訂單

      - ###### MySQL 資料庫:payment 資料表: order_tp

      - ###### 透過SerialNumber查詢

   2. ##### 處理付款資料 

      - ######  HandlerOrderAmount( notifyService, payResultMsg.PayDate, ref transactionType );

      - ###### 取得訂單明細表(MySQL) 資料庫payment 資料表: client_payment_detail

      - ###### 依據訂單內容進行資料處理

      - ###### 付款確認成功後，會將成功的那筆點擊支付紀錄的單號押回CPD.hitrust_sn

        


## 各支付平台回傳導頁設定

### 藍新

```C#
//TradeInfo內容
{
    sort.Add("MerchantID", _mch_id); //商店代號 必填
    sort.Add("RespondType", "JSON"); // 回傳格式必填 JSON/String
    sort.Add("TimeStamp", timeSpan.ToString()); //時間標記 必填
    sort.Add("Version", "1.4");//串接程式版本
    sort.Add("MerchantOrderNo", orderId);//訂單編號 必填,30字以內且同一個特店不可重複
    sort.Add("Amt", amt); //金額必填
    sort.Add("ItemDesc", prodName);// 商品資訊 必填
    sort.Add("LoginType", "0"); //是否需要登入藍新會員
    sort.Add("ReturnURL", _returnUrl);//支付完成後導頁網址,若為空值則停留在藍新結果頁面
    sort.Add("NotifyURL", _notifyUrl);//支付成功後通知網址
    sort.Add("UNIONPAY", "1"); //信用卡銀聯卡啟用
    sort.Add("LangType", _locale); //語系 ex. en,zh-tw,jp
    if (period <= 1)
        sort.Add("CREDIT", "1"); // 使否啟用信用卡紅利支付
    else
        sort.Add("InstFlag", period.ToString());   //信用卡分期啟用，利用,號分開(3,6,12) 
}

sort.Add("TradeInfo", EncryptAes(sort)); //交易資料 AES加密必填(依據商店的key及iv進行加密)
sort.Add("TradeSha", Signature(sort["TradeInfo"])); //交易資料進行SHA256加密(依據商店的key及iv進行加密)
```

### 綠界

- ```C#
  {
      //-----
  	var dict = new SortedDictionary<string, string>
      {
          //特店編號必填
          {"MerchantID", uniqueParameter.MerchantID},
          //特店訂單編號必填
          {"MerchantTradeNo", data.OrderId},
          //特店交易時間必填
          {"MerchantTradeDate", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss")},
          //交易類型 必填
          {"PaymentType", _config.PaymentType},
          //交易金額 必填
          {"TotalAmount", data.Amount.ToString()},
          //交易描述 必填
          {"TradeDesc", data.TradeDesc},
          //商品名稱 必填
          {"ItemName", data.ProductName},
          //付款完成通知回傳網址 必填
          {"ReturnURL", _config.ReturnURL},
          /*
          選擇預設付款方式
              Credit：信用卡及銀聯卡(需申請開通)
              WebATM：網路ATM
              ATM：自動櫃員機
              CVS：超商代碼
              BARCODE：超商條碼
              ApplePay: Apple Pay(僅支援手機支付)
              ALL：不指定付款方式，由綠界顯示付款方式選擇頁面。
          */
          {"ChoosePayment", _config.ChoosePayment},
          //{ "ClientBackURL", _config.ClientBackURL },
          //改为由调用方传入地址
          {"ClientBackURL", data.ResultURL},
          {"CreditInstallment", data.InstallmentTimes > 1 ? data.InstallmentTimes.ToString() : string.Empty},
          {"NeedExtraPaidInfo", _config.NeedExtraPaidInfo},
          //EncryptType  固定1
          {"EncryptType", "1"},
          {"Language", Language}
      };
  
      var sb = new StringBuilder();
      
      //GateWay: 綠界API位置
      sb.Append($"<form id=\"pay_form\" action=\"{_config.GateWay}\" method=\"post\">");
  
      //將上面設定的欄位帶入form data中,在Post時一併傳遞
      foreach (var item in dict)
      {
          sb.Append($"<input name=\"{item.Key}\" type=\"hidden\" value=\"{item.Value}\"/>");
      }
      // CheckMacValue 檢查碼 必填
      sb.Append($"<input name=\"CheckMacValue\" type=\"hidden\" value=\"{Signature(dict)}\"/>");
      sb.Append("</form>");
      sb.Append("<script language=\"javascript\">window.onload = function() {document.getElementById(\"pay_form\").submit();}</script>");
      return sb.ToString();
  }
  
  public string Signature(SortedDictionary<string, string> data)
  {
      var hashKey = _config.HashKey;
      var hashIv = _config.HashIV;
      var midName = "MerchantID";
  
      //绿界24期用专用的商户号
      if (data.ContainsKey(midName) && data[midName] == _config.Pay24PeriodConfig.MerchantID)
      {
          hashKey = _config.Pay24PeriodConfig.HashKey;
          hashIv = _config.Pay24PeriodConfig.HashIV;
      }
      else if ( data.ContainsKey( midName ) && data[midName] == _config.EscrowConfig.MerchantID) //綠界履約保證
      {
          hashKey = _config.EscrowConfig.HashKey;
          hashIv = _config.EscrowConfig.HashIV;
      }
  
      var text = $"HashKey={hashKey}&{string.Join("&", data.Select(a => a.Key + "=" + a.Value))}&HashIV={hashIv}";
  
      MongoLogHelper.Write($"绿界验签内容：{text}");
  
      return SHA256Crypto(text);
  }
  ```
  
  

## 補充說明

- #### 資料表關聯

  - **CPR**裡面有合約單號`contract_sn `
  - **CPD**的`payrecord_sn ` = CPR.ID
  - **hitrust_record_all** 的order_number  = `contract_sn `、`payment_detail_sn `= CPD.ID
  - 每次付款都會建立**hitrust_record_all **，點擊紀錄的ID會作為Order的編碼
  - 28203開始建立支付單時，會產生ms_payment_pay_request 、ms_payment_pay_history 
    - ms_payment_pay_history的order_sn = hitrust_record_all .ID
    - ms_payment_pay_history的order_id = 送至三方對應的 **特店單號**

- #### 備註流程

  - 透過合約單號可以找到CPR、hitrust_record_all

  - 透過CPR可以找到CPD

  - 透過CPD 可以找到hitrust_record_all

  - 透過hitrust_record_all可以找到ms_payment_pay_request 、ms_payment_pay_history 

    - ms_payment_pay_history的SerialNumber

  - 透過CPD單號查到hitrust_record_all，hitrust_record_all的` order_number   + ID` = 三方的單號

  - #####  CAllback回推單號流程

    1. 透過支付回傳的orderNo，找到ms_payment_pay_history  
       - `order_id = MerchantOrderNo `
    2. 透過ms_payment_pay_history回推點擊支付紀錄
       - ms_payment_pay_history.order_sn = hitrust_record_all .ID
    3. 付款確認成功後，會將成功的那筆點擊支付紀錄的單號押回CPD.hitrust_sn

- #### ISSUE

  - 查詢訂單資料及付款狀況

    - ```sql
      SELECT * FROM payment.client_payment_record where contract_sn = 合約編號;
      
      SELECT * FROM payment.client_payment_detail where payrecord_sn = CPD.ID; 
      
      select * from hitrust_record_all where order_number= 合約編號;
      
      select * from ms_payment_pay_history where order_id=送往特店的訂單編號;
      
      SELECT * FROM ms_payment_pay_response where serial_number= ms_payment_pay_history.serial_number;
      
      ```
      
      
  
  

## 資料表說明

1. ### cfg_pay_platform

   - | Field Name        | Data Type      | Description                                                  |
     | ----------------- | -------------- | ------------------------------------------------------------ |
     | id                | int(PK,AI)     |                                                              |
     | pay_mode_sn       | 付款方式       | client_payment_detail.payment_mode<br />[muchnewdb.dbo.cfg_pay_mode.sn](http://muchnewdb.dbo.cfg_pay_mode.sn/) |
     | pay_platform_code | 商店、平台id   | client_payment_detail.storeid                                |
     | pay_platform_name | 商店、平台名称 |                                                              |
     | ref_store_id      | 商店、平台id   | lient_payment_detail.storeid                                 |
     | sort              | int            |                                                              |
     | valid             | it             | 前端用以显示的值，数据逻辑不需要限定这个条件。               |
     | creator_id        | int            |                                                              |
     | created_at        | datetime       |                                                              |
     | cfg_store_sn      | nvarchar       |                                                              |
     | maximum_amount    | int            |                                                              |
     | minimal_amount    | int            |                                                              |
     | web_site          | nvarchar       |                                                              |
     | pay_type          | nvarchar       |                                                              |
     | image_name        | nvarchar       |                                                              |
     | enum_code         | nvarchar       | 英文代碼，對應API傳入bank                                    |
     | display_name      | nvarchar       |                                                              |
     | period            | nvarchar       |                                                              |
     | payment_code      | int            | 支付方式代碼(ex.41(綠界)，58(綠界分期))                      |
     | is_online_payment | int            |                                                              |
     | installment_type  | int            |                                                              |

   

2. ### ms_payment_pay_config

   | Field Name  | Data Type     | Description                                 |
   | ----------- | ------------- | ------------------------------------------- |
   | id          | int(11)       |                                             |
   | bank        | int(11)       | 支付代碼，對應cfg_pay_platform.payment_code |
   | config_type | int(11)       |                                             |
   | config_xml  | varchar(4000) | 支付方式設定內容                            |
   | code        | varchar(20)   |                                             |
   | dist        | varchar(10)   | 幣別                                        |
   | name        | varchar(20)   | 名稱                                        |
   | type        | tinyint(4)    |                                             |
   | period      | varchar(45)   | 分期設定                                    |
   | desc        | varchar(200)  | 說明                                        |
   | sort        | tinyint(4)    |                                             |
   | ex_property | varchar(2000) |                                             |

   

3. ### [其他支付相關資料表](http://tp-km.tutorabc.com/pages/viewpage.action?pageId=64247277)

   

## 訂單查詢流程

### 藍新

- #### 必要參數

  - ##### 該筆訂單付款金額

  - ##### 訂單單號(hitrust_record_all的` order_number + ID` )

- ##### 範例程式碼

  - ```C#
    public async Task<NewebPayReturn<NewebPayQueryResult>> GetQueryCallBack(string orderId, string amt)
    {
        //需填入 你的網址
        var website = $"{Config.GetSection("HostURL").Value}/Home";
    
        //順序必須一樣
        var order = new Dictionary<string, string>
        {
            //特店交易編號
            { "Amt",  amt},
            //特店編號， 2000132 測試綠界編號
            { "MerchantID",   "MS325135187"},
            //特店交易編號
            { "MerchantOrderNo",  orderId}
        };
    
        string TradeInfoParam = string.Join("&", order.Select(x => $"{x.Key}={x.Value}"));
        string HashKey = "Zf086cln2XzdF38U7ouR6zdXJMCAip7i";//API 串接金鑰
        string HashIV = "F7qMkL9mJIApMIjT";//API 串接密碼
        string TradeInfoEncrypt = EncryptAESHex(TradeInfoParam, HashKey, HashIV);
    
        //順序必須一樣
        order.Add("CheckValue", EncryptSHA256($"IV={HashIV}&{TradeInfoParam}&Key={HashKey}").ToUpper());
        order.Add("Version", "1.3");
        order.Add("RespondType", "JSON");
        order.Add("TimeStamp", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"));
    
        var content = new FormUrlEncodedContent(order);
    
        using (HttpClient client = new HttpClient())
        {
            HttpResponseMessage response = await client.PostAsync("https://core.spgateway.com/API/QueryTradeInfo", content);
            var result = await response.Content.ReadAsStringAsync();
            return JsonConvert.DeserializeObject<NewebPayReturn<NewebPayQueryResult>>(result);
        }
    
        return null;
    
    }
    ```

  - ```C#
    public class NewebPayReturn<T>
    {
        public string Status { get; set; }
        public string Message { get; set; }
        public T Result { get; set; }
    }
    
    public class NewebPayQueryResult
    {
        public string MerchantID { get; set; }
        public string MerchantOrderNo { get; set; }
        public string TradeNo { get; set; }
        public int Amt { get; set; }
        public string TradeStatus { get; set; }
        public string PaymentType { get; set; }
        public DateTime CreateTime { get; set; }
        public DateTime PayTime { get; set; }
        public string CheckCode { get; set; }
        public DateTime FundTime { get; set; }
        public string ShopMerchantID { get; set; }
    }
    ```


# 新增支付渠導流程

## 28202處理

1. #### 新增支付對應表

   1. SQL Server-muchnewdb(cfg_pay_mode)

      - ###### 定義支付方式(sn:23代表刷卡、139代表訂閱)

      - CPD.pay_mode_sn、cfg_pay_platform.pay_mode對應此表ID欄位

      - ###### [cfg_pay_mode](http://tp-km.tutorabc.com/display/BI/cfg_pay_mode)

   2. SQL Server-muchnewdb(cfg_storeid)

      - ###### 支付渠道設定

   3. MySQL - Payment (cfg_pay_platform)

      - 定義支付表單(需新增)

      - ###### [cfg_pay_platform](http://tp-km.tutorabc.com/display/BI/cfg_pay_platform)

      - ```SQL
        INSERT INTO cfg_pay_platform(pay_mode_sn ,pay_platform_code ,pay_platform_name,  sort, valid, creator_id,created_at,web_site,pay_type,image_name,enum_code,display_name,payment_code,is_online_payment,installment_type,company_location)
        VALUES (23, 99, "香港支付平台", 1, 1, 275, now(), 'T', 'ThirdPayment', 'Hk.png', 'hkpay', '香港支付平台', 99, 1 ,0,'HK')
        ```
   
   4. SQLServer - muchnewdb(CfgPayPlatform)

      - 定義支付表單(需新增)

      - ```sql
        INSERT INTO  TutorDefinition.dbo.CfgPayPlatform
                   (PayModeSn,PayPlatformCode, PayPlatformName, Sort, Valid, CreatorId, CreatedAt, WebSite, PayType, ImageName, EnumCode, DisplayName, PaymentCode, company_location)
             VALUES
                   (23,99, N'香港支付平台', 1, 1, 275, GETDATE(), 'T', 'ThirdPayment', 'Hk.png', 'hkpay',  N'香港支付平台', 99, 'HK')
        ```
   
2. #### 新增列舉值

   - ###### TutorGroup.VIPABC.PaymentWeb\Enums\Bank.cs

3. #### 調正ModelMapping

   - ###### 28202.Payment.Web\TutorGroup.VIPABC.PaymentWeb.API\Common\BankMapping.cs

## 28203處理

1. #### 新增支付設定

   - ###### MYSQL - Payment (ms_payment_pay_config)

   - config_type: 設定檔環境

     - 0:开发 1: 正式 2: 测试(244)  3: Stage

   - ```sql
     INSERT INTO ms_payment_pay_config
     (bank, config_type, dist, name , type, sort, config_xml)
     Values
     (99, 1, 'HK', '香港支付平台', 1, 1,'{ "TokenUrl": "https://api.tutorabc.com.hk/TokenKey", "CommonKey": "20081010", "RedirectUrl": "https://www.tutorabc.com.hk/Checkout", "ReturnUrl": "http://www.tutorabc.com", "CallbackUrl":"http://stagepay.tutorabc.com/PaymentPlatform/hkpay/NotifyMsg" }')
     ```
   
2. #### 新增支付設定對應類別

   - ###### 透過config_type及bank對應步驟1表單資料

   - ###### TutorGroup.Payment.BankInterface\Configurations\HKPayConfig.cs

3. #### 新增列舉值

   - ###### TutorGroup.Payment\Enums\Bank.cs

4. #### 新增支付處理方法

   - ###### TutorGroup.Payment.BankInterface\HKPay\Helps.cs

5. #### 驗證付款銀行資料處理(**PayBankFactory.PaymentToBankService.Verify**)

   - ###### TutorGroup.Payment.BankInterface\Services\PaymentToBankService.cs

   - ###### 新增對應Verify方法

6. #### 新增Callback方法

   - ###### TutorGroup.Payment.API\Payment\HKPayNofity.cs

   - ###### 新增對應Model

     - ###### TutorGroup.Payment.API\Models\HKPayNotifyRequest.cs

## ClientServiceUI

- ## 取得支付渠道

  1. ##### Call ClientServiceAPI取得付款詳情

     - ###### 路徑: clientserviceapis\ClientServiceAPIs\Controllers\OrderController.cs

     - ###### API: GetPaymentDetail/{detailSn} (GetPaymentDetail)

     - ###### 過濾方式:

       - ###### 透過幣別判斷支付國家位置

         - ###### 台幣= 國內支付(TW)
  
         - ###### 外幣 = 香港支付(HK)
  
       - ##### 呼叫28201取得Website=T的支付方式
  
         - ###### Payment.MemberCenter.28201\TutorGroup.VIPABC.MemberWeb.WebSite\Controllers\PaymentController.cs 
  
       - 依據28201回傳的清單中`CompanyLocation`過濾支付國家位置
  
  2. #### 目前外幣產品都直接導向HK Pay，因此在頁面中做另外處理
  
     - ##### 路徑: ClientServiceUI\src\pages\OrderDetail\index.tsx
  
     - ##### 台幣產品
  
        - ###### 點擊付款後，轉導至付款詳情頁面(ClientServiceUI\src\pages\PaymentDetail\DetailForm.tsx)
  
        - ###### 呼叫GetPaymentDetail取得付款明細並列出
  
     - ##### 外幣產品
  
        - ###### 點擊付款後，呼叫handlePayment直接導向HKPAY
  
  3. #### Git Commit參考(支付加入美金付款渠道: fe4e926c2832719ad06e27a0f3c671b75ec3de95)
  

## online-cashier-next

- #### 付款頁面調整

  - ###### components\PaymentForm\index.tsx

  - 新增ICON

  - ###### 付款選項內容:

    - renderInvoiceBlock(539)

  - 上方付款選項Icon

    - 627行

- #### 調整付款Call API URL

  - ##### constants\index.ts

  - ##### 新增付款方式API

- #### 目前外幣產品直接導向香港支付，不會出現選擇付款Block

- #### Git Commit參考(國外支付項目調整:3fdcb5d5f73eb4ea687fa88f72355f000cf73f4e)



# 虛擬帳戶(ATM轉帳)

- #### 程式路徑:

  - ##### 28202.payment.web\TutorGroup.VIPABC.PaymentWeb.API\Controllers\VirtualAccountController.cs

- ##### API: api/VirtualAccount/post

- ##### Bank  = 74

- ### 流程

  1. #### 透過ClientService API轉導至28202(透過DetailSn)

  2. ####  取得CPD資訊

  3. ####  取得虛擬帳戶寫入紀錄`virtual_account_write_off_record`

     - ##### 透過合約號跟CPD ID 

  4. #### 取得新的帳戶

     1. ##### 沒有寫入紀錄/虛擬帳戶ExpireDate小於今天

     2. ##### 產生虛擬帳戶

        - ###### TutorGroup.VIPABC.PaymentWeb.Services\Services\VirtualAccountService.cs

        - ###### GenerateVirtualAccount傳入合約、DetailSn、金額

        - #### 流程

          1. ##### 取得銷帳編號(繳款截止日(3碼) + 合約編號(後5碼))

          2. ##### 產生不含檢查碼之虛擬帳號 = 企業識別碼(5碼) + 銷帳編號(8碼)

          3. ##### 檢核帳號、金額及繳款截止日

          4. ##### 取得點擊付款紀錄(GetHitrustRecordAll)

             - ###### 如果存在: ThirdOrderNo=虛擬帳戶

             - ###### 不存在則新增

               - ###### Type = 付款方式描述

               - ###### CompType = Bank Enume(74)

  5. #### 更新virtual_account_write_off_record

     1. ##### 如果步驟3有取得則更新

     2. ##### 沒有則新增

## Callback

- ##### API: https://pay.tutorabc.com/payment/notify/esun

- ##### 路徑:  28203.payment.api\TutorGroup.Payment.API\Controllers\BankNotifyController.cs

- ##### 回傳參數:字串

  - ```
    20220921,銀行,1,94696267141488,50000,20220921165639,107894000889801110921CR+00000005000015+00003864654610ＡＴＭ跨行轉267141488 00004009006006517685590094696001501110921165639",{"referer":null,"remoteAddr":"61.220.45.142","logType":"Operation","userAgent":"Java/11.0.8","url":"https://pay.tutorabc.com/payment/notify/esun","orderSn":"","customId":"0","serverId":"1","userId":"0"},""]
    ```

- #### 流程

  1. ##### 取回`hitrust_record_all`

     - ###### third_order_no = 回傳的帳號

     - ###### comptype=74

  2. ##### Call 28202 Notify API `/api/Notify`走回付款後流程

     1. 判斷付款是否成功
     2. 判斷金額是否一致
     3. 處理相關資料表
     4. 更新虛擬帳戶表
     5. 產生綠聯單(28206 /command/paperno)
     6. 發送付款通知(28206)



## 相關資料表

```sql
SELECT * FROM payment.client_payment_detail where id = 10114908;	
 
SELECT * FROM hitrust_record_all WHERE payment_detail_sn=10114908;

SELECT * FROM virtual_account_write_off_record
WHERE contract_sn = 1457845 and payment_detail_sn=10114908
```



# 貸款-富國

- ##### 路徑: 28204.Payment.Loan\CashFlow.Web\Controllers\OnlineLoanPlatformController.cs

- ##### API: https://onlineloan.tutorabc.com/onlineloanplatform/ApplyEFHBypaymentdetailsn?paymentDetailSn=10115027

- ### 流程

  1. #### 取得相關付款資訊(muchnewdb)CPR、CPD

  2. #### 取得會員資料

  3. #### 取得CPR上的發票資訊 (muchnewdb)

  4. #### 進行付款前準備

     - ##### Controllers\EFHOnlineLoanController.cs (downPaymentEFH)

     - ##### 進到富比士興業刷卡前，呼叫此API再呼叫富比士興業API，取得回傳的html內容，回覆給官網

     - ##### 參數樣式

       - ```
         {"Dsn":"101XXX93","ClientAddress":"民權東XXXXXX3號六樓","invoice":"0","invoice_num":"","invoice_header":"","cname":"XXX","tel_code":"09XXX0190","tel":null,"email":"oXXXX91830@gmail.com","clientIp":"172.16.21.XXX","userid":"275","requestUrl":null,"clientSn":XXX0}
         ```

     - #### 流程

       1. ##### 驗證傳入資料

          1. ###### 驗證付款資訊

          2. ###### 驗證客戶資訊

       2. ##### 新增hitrust_record_all (MySQL、Muchnew)

          1. ###### 新增頭期款

          2. ###### 新增定期定額款

       3. ##### 更新CPD

       4. ##### 取得付款金額、期數

       5. ##### 產生PostData

          - ```C#
              StringBuilder apiData = new StringBuilder();
                            apiData.Append("CARINSADD_NEW,");   // Action
                            apiData.AppendFormat("{0},", ConfigurationManager.AppSettings["EFHChannelBR"]);  // 通路商店(分公司)代碼
                            apiData.AppendFormat("{0},", applySer);   // 通路訂單編號
                            apiData.Append(","); // CIFID 身分證號碼全部
                            apiData.AppendFormat("{0},", drPaymentInfo.str("cname"));   // Name 客戶姓名(中文)
                            apiData.AppendFormat("{0},", personInfo.Mobile);  // CellPhone drPaymentInfo.str("cphone")
                            apiData.AppendFormat("{0},", personInfo.Email);  // EMAIL drPaymentInfo.str("email")
                            apiData.AppendFormat("{0},", string.IsNullOrEmpty(personInfo.Birthday) ? "" : personInfo.Birthday.Replace("-", ""));  // Birth 客戶生日
                            apiData.AppendFormat("{0},", billArea);  // Bill_Area 客戶通訊地址郵遞區號
                            apiData.AppendFormat("{0},", clientAddress);  // Bill_Addr 客戶通訊地址(中文全型)
                            apiData.AppendFormat("{0},", personInfo.LegalName);  // AgentName 法定代理人姓名(中文) drPaymentAmount.str("legalName")
                            apiData.AppendFormat("{0},", salesAmt.ToString());  // SalesAmt 契約金額
                            apiData.AppendFormat("{0},", downPaymentAmount.ToString());  // Deposit 訂金
                            apiData.AppendFormat("{0},", paymentAmount.ToString());   // ApproveAmt 代收總金額
                            apiData.AppendFormat("{0},", drPaymentAmount.str("creditCardInstallment2"));   // Term 期數
                            apiData.AppendFormat("{0},", payday);   // Payday 指定支付日
                            apiData.Append("0,");  // HeadTemAmt 首期指定金額
                            apiData.AppendFormat("{0},", drPaymentInfo.str("handling"));  // CHAN_SALES 通路業務姓名或業務代碼
                            apiData.Append(",");    // SALE_CellPhone 通路業務手機
                            apiData.AppendFormat("{0},", drPaymentInfo.str("sdate", "yyyyMMdd"));   // 合約起日
                            apiData.AppendFormat("{0}", drPaymentInfo.str("edate", "yyyyMMdd"));   // 合約迄日
                            string encodedApiData = sTripleDESEncoding(apiData.ToString(), ConfigurationManager.AppSettings["EFHAPIKey"]);
            ```

          - ###### 新增OnlineLoanEFHStepHistory(Muchnew)

       6. ##### 呼叫富國API

          - ###### 可以查詢LOG ，關鍵字:`DownPaymentEFH: EFH_API`

          - 進件失敗

            - 更新OnlineLoanEFHRecord

          - 進件成功

            - 回傳結果

  5. #### 將客戶導向富國頁面

## Callback

- ##### 28204.Payment.Loan\CashFlow.Web\Controllers\EFHOnlineLoanController.cs

- ##### ResultNotify

- ### 流程

  1. 



# 訂閱流程

## 訂單流程

1. #### 業務建立合約(CPR)，並選擇付款方式(CPD)

2. #### 客戶付款(透過藍新約定信用卡授權方式)

3. #### 藍新回傳支付結果，並將付款Token一併回傳(後續定期定額都用Token處理)

   - ##### 付款流程參考下方

4. #### 開通合約

   - ### 自動排程

   - ##### 路徑: Oms.Global\Oms.Global.Service\Service\OmsApi\Business\Contract\ContractService_Subscription.cs

   - ##### 流程； 

     1. ###### 根據合約代號取得訂閱合約紀錄

        - MySQL: Oms_Order-subscription_record

     2. ###### 若查無該合約的訂閱紀錄，代表其為第一次建立訂閱合約

     3. ###### 建立下一期訂閱紀錄

   - ### 是否表示每次開通本次合約後，都會定期找出新的訂閱合約?或是排程?

## 一般訂閱制付款

- ##### 程式路徑: 28203.Payment.API\TutorGroup.Payment.API\Controllers\SubscriptionController.cs

- ##### API: Subscription/NewebPayAuthorize

- ### 流程說明

  1. #### 檢查傳入參數內容

  2. ####  建立付款請求參數 (ServiceFactory.SubscriptionService.GenerateNewebPayAuthorizeParameter)

     1. ##### 取得付款明細(CPD) 

        - ###### 程式:_paymentRepository.SelectClientPaymentDetail(cpdSn)

        - ###### MySQL 資料庫:payment 資料表client_payment_detail

     2. ##### 處理點擊支付紀錄: 

        - ###### MySQL 資料庫:payment 資料表`hitrust_record_all` 

          - ###### 若查無資料: 新增SQL Server資料`hitrust_record_all`

          - ###### 若存在紀錄則更新金額

     3. ##### 處理訂閱授權資訊

        - ###### 程式: `InsertOrUpdateAuthNewebPay(subscriptionSn, merchantOrderNo, cpd.Amount, productName, clientSn, email);`

        - ###### MySQL 資料庫:payment 資料表subscription_auth 

          - ###### 若無則新增訂閱資訊

        - ###### MySQL 資料庫:payment 資料表subscription_auth_newebpay (藍新訂閱授權資訊)

          - ###### 若取不到藍新訂閱授權資料，則新增一筆紀錄

          - ###### 取到則判斷金額是否相同，不同則更新訂單(金額)

          - ###### subscription_auth 的 `pay_mode_auth_sn` 對應 subscription_auth_newebpay  `ID`

     4. ##### 建立藍新支付XML

        - ##### 呼叫藍新API `MPG/mpg_gateway`

        - ##### 導致刷卡頁面

        - ###### MerchantOrderNo = contractSn+hitrustSn

  3. #### Client 至藍新畫面進行信用卡刷卡第一期訂閱金額

  4. #### 用戶付款完成後，藍新Callback

     - ##### 程式路徑:  28203.Payment.API\TutorGroup.Payment.API\Controllers\SubscriptionController.cs

     - ##### API: Subscription/NewebPayAuthorizeNotifyResult

     - #### 訂閱成功流程

       1. ##### 取得歷史紀錄

          - ###### MySQL 資料庫:payment 資料表client_payment_detail

          - ###### MySQL 資料庫:payment 資料表subscription_auth 

          - ###### MySQL 資料庫:payment 資料表subscription_auth_newebpay 

          - ###### MySQL 資料庫:payment 資料表hitrust_record_all

       2. ##### 更新資料表

          - ###### MySQL 資料庫: payment 資料表subscription_auth 

          - ###### MySQL 資料庫: payment 資料表subscription_auth_newebpay 

       3. ##### 新增訂閱付款紀錄(每次訂閱付款後，藍新回傳)

          - ###### MySQL 資料庫:payment 資料表subscription_pay_record

       4. ##### 更新擊支付紀錄: 

          - ###### MySQL 資料庫:payment 資料表`hitrust_record_all` 

          - ###### 更新欄位:RetCode(支付返回訊息)、OutDate(支付返回時間)、ThirdPartyId(訂單編號)、ThirdOrderNo(三方支付訂單號)

       5. ##### 更新付款明細(CPD) 

          - ###### MySQL 資料庫:payment 資料表client_payment_detail

          - ###### 更新欄位: 付款方式(payment_mode)、商店代號(store_id)、支付紀錄ID(hitrust_sn)、綠聯單確認時間(p_adate)、是否購買(is_buy)

       6. ##### 檢查發票紀錄

          - ###### MySQL 資料庫:payment 資料表client_invoice_info

          - ##### 若無發票紀錄，則新增:

            - ###### 取得訂閱制發票資訊: MySQL 資料庫:payment 資料表client_invoice_info

            - ###### 建立發票紀錄檔

       7. ##### 至28206取綠聯(透過CPD.ID)

          - ##### API: "/command/paperno"

          - ##### 程式路徑: 28206.Payment.FST-API\FstApi\TGOP.ServiceNode.FstApi.ServiceCore\ApiService\FstApiService_FstCommand.cs

          - ##### 流程:

            1. ##### 取得合約相關資訊(透過CPD.ID串聯)

               - ###### SQL Server資料庫`client_payment_detail` 

               - ###### SQL Server資料庫`client_payment_record` 

               - ###### SQL Server資料庫`client_temporal_contract` 

               - ###### SQL Server資料庫`cfg_product` 

            2. ##### 若合約位置(Web_Site)不為台灣，則中斷

            3. ##### 取得綠連單號

               1. ###### 取得品牌代號(TutorABC、TutorABCJr)

               2. ###### 取得CPD紀錄 (SQL Server資料庫client_payment_detail)

               3. ###### 取得支付方資訊 (SQL Server資料庫CfgPayPlatform)

               4. ###### 透過序號回CPD資料表取得最大號碼(paper_no)

                  - ###### 序號產生方式:  $"{前贅字}{DateTime.Now.ToString("yyMMdd")}{步驟3.1 的值}"

                  - ###### 如果有指定綠連單號 $"{preFix}{Convert.ToDateTime(paperNoDate).ToString("yyMMdd")}{result}"

               5. ###### 回傳綠聯單號: 序號 + 最大單號+1

            4. ##### 更新CPD資料表(綠聯相關欄位)

               - ###### 更新MySQL跟SQL Server資料庫

       8. ##### 透過28206發送通知

          - ##### API: "/notify/payinfo"

          - ##### 程式路徑: 28206.Payment.FST-API\FstApi\TGOP.ServiceNode.FstApi.ServiceCore\ApiService\FstApiService_OmsOrder.cs

          - ##### 流程

            1. ##### 處理整单完款

               1. ###### 取得付款紀錄表資料

                  - ###### MySQL 資料庫: payment 資料表client_payment_record

                  - ###### MySQL 資料庫:payment 資料表client_payment_detail(計算已付款金額用)

                  - ```
                    select cpr.contract_sn as ContractSn,cpr.amount as Amount,(select ifnull(sum(b.amount),0)
                    from client_payment_record a 
                    inner join client_payment_detail b  on a.id= b.payrecord_sn and a.valid= 1 and a.contract_sn=@csn  and b.is_buy= 1) as PaidAmount,
                    ifnull(cpr.completion_status, 0) CompletionStatus
                    from client_payment_record cpr 
                    where cpr.source_Id >= 2 and cpr.valid = 1
                    ```

                  - Amount:訂單金額 PaidAmount:已付款金額

               2. ##### 如果完款狀態 = 0

                  - 若付款金額 >= 合約金額，
                    - 已完款，重置未支付的明细（折让除外）
                    - 更新`client_payment_record` 及 `client_payment_detail`

               3. ##### 步驟1、2重複更新SQL Server資料庫

            2. ##### 取得其他已付款合約紀錄

            3. ##### 將合約號碼、總付款金額及本次付款金額傳送到QUEUE

               

## 訂閱制鑑賞期付款

- ##### 程式路徑: 28203.Payment.API\TutorGroup.Payment.API\Controllers\SubscriptionController.cs

- ##### API: Subscription/NewebPayAuthorizeByFirstFree

- ### 流程說明

  1. #### 檢查傳入參數內容

  2. ####  建立付款請求參數 (ServiceFactory.SubscriptionService.GenerateNewebPayAuthorizeParameterForFirstFree)

     1. ##### 取得付款明細(CPD) 

        - ###### 程式:_paymentRepository.SelectClientPaymentDetail(cpdSn)

        - ###### MySQL 資料庫:payment 資料表client_payment_detail

     2. ##### 處理訂閱授權資訊

        - ###### 程式: `InsertOrUpdateAuthNewebPay(subscriptionSn, merchantOrderNo, 1, productName, clientSn, email);`

        - ###### MySQL 資料庫:payment 資料表subscription_auth 

          - ###### 若無則新增訂閱資訊

        - ###### MySQL 資料庫:payment 資料表subscription_auth_newebpay (藍新訂閱授權資訊)

          - ###### 若取不到藍新訂閱授權資料，則新增一筆紀錄

          - ###### 取到則判斷金額是否相同，不同則更新訂單(金額)

          - ###### subscription_auth 的 `pay_mode_auth_sn` 對應 subscription_auth_newebpay  `ID`

     3. ##### 建立藍新支付XML

        - ##### 呼叫藍新API `MPG/mpg_gateway`

        - ##### 刷卡金額 1元

        - ###### MerchantOrderNo = ContractSn + 執行日期

  3. #### Client 至藍新畫面進行信用卡刷卡驗證(一元)

  4. #### 用戶付款完成後，藍新Callback

     - ##### 程式路徑:  28203.Payment.API\TutorGroup.Payment.API\Controllers\SubscriptionController.cs

     - ##### API: Subscription/NewebPayAuthorizeNotifyResultByFirstFree

     - ### 流程

       1. ##### 取得歷史紀錄

          - ###### MySQL 資料庫:payment 資料表client_payment_detail

          - ###### MySQL 資料庫:payment 資料表subscription_auth 

          - ###### MySQL 資料庫:payment 資料表subscription_auth_newebpay 

       2. ##### 新增訂閱付款紀錄(每次訂閱付款後，藍新回傳)

          - ###### MySQL 資料庫:payment 資料表subscription_pay_record

       3. ##### 更新資料表

          - ###### MySQL 資料庫: payment 資料表subscription_auth 

          - ###### MySQL 資料庫: payment 資料表subscription_auth_newebpay 

       4. ##### 取消試刷紀錄(step 3 驗證信用卡的一元刷卡紀錄)

          - ###### 呼叫藍新API `API/CreditCard/Cancel`進行授權取消

            - ###### 透過訂單號: merchantOrderNo

            - ###### 成功取消: 

              - ###### 新增紀錄至 MySQL 資料庫:payment 資料表subscription_refund_record

            - ###### 失敗: 發送失敗信件

              

## 建立下期訂閱單排程

- ##### 路徑: NewFoundation\Oms.Global\Oms.Global.Service\Service\OmsScheduleApp\ScheduleService.cs > SubscriptionCreateRenew

- ### 流程

  1. ##### 取得要續約的訂閱制清單

     - ###### 路徑: NewFoundation\OmsFoundationApi\TGOP.ServiceNode.OmsFoundationApi.ServiceCore\ApiService\ContractApiService.cs

     - ###### API: /business/contract/subscription/needrenew

     - ###### 至MySQL-OMS_Order-subscription_record取得下一期訂單資料

       - 查詢日期: pre_order_date: 在四天前~一天後的資料區間
       - 合約號(contract_sn): 0 代表還沒綁定CPR

  2. ##### 取得產品資訊

  3. ##### 產生本期合約

     - ###### client_temporal_contract 

     - ###### 產生合約號 Contract_Sn =  id

  4. ##### 新增支付記錄

     - ###### 路徑: 28207.Payment.IMS\IMS.Payment\Controllers\PaymentController.cs

     - ###### API: api/payment/order/add

     - ###### 新增CPR、CPD記錄

  5. #####  更新下一期訂閱單

     - ###### 將步驟3產生的合約單號更新回下一期的訂閱單subscription_record.contract_sn中\

       

## 定期定額付款

- ##### 付款程式路徑:  28203.payment.api\TutorGroup.Payment.API\Controllers\SubscriptionController.cs (NewebPayCreditCardPayBatch)

- ##### 流程說明:

  1. ##### 每日排程啟動(126)

  2. ##### 取得訂閱待付款合約清單

     - 程式路徑:  newfoundation\Oms.Global\Oms.Global.Service\Service\OmsApi\Business\Contract\ContractService_Subscription.cs

     - GetNeedPayContractRecord()

     - 取得需要付款的訂閱紀錄

       - SubscriptionService.Instance.GetNeedPayRecords(startDate, endDate);
       - 查詢日期: pre_order_date: 在四天前~一天後的資料區間
       - 合約號(contract_sn): 0 代表還沒綁定CPR

     - ##### 取得尚未開通的合約

       - 付款排程前，都會有另一個排程建立下一期合約
       - 資料表: client_temporal_contract

  3. #### 取得產品資訊

  4. #### 針對每筆合約進行付款動作

     1. ##### 透過合約號取得CPD

     2. ##### 透過基礎合約(BaseContractSn)取得授權記錄檔(SubscriptionAuth)

     3. ##### 透過授權記錄檔的(PayModeAuthSn)對應到藍新授權記錄檔SubscriptionAuthNewebpay(ID)

     4. ##### 新增支付紀錄檔案(HitrustRecordAll)`目前是一個CPD 對應一筆`

     5. ##### 呼叫藍新API進行付款動作(MerchantOrderNo = contractSn+ hitrust.Id)

     6. ##### 付款成功處理

        1. ###### 建立訂閱支付紀錄`SubscriptionPayRecord`

        2. ###### 更新HitrustRecordAll內容

        3. ###### 更新CPD內容

        4. ###### 更新發票設定

        5. ###### 取綠聯

        6. ###### 發通知

     7. ##### 付款失敗處理

        1. ###### 建立訂閱支付紀錄`SubscriptionPayRecord`

        2. ###### 更新HitrustRecordAll內容



## 取消訂閱

- ##### API: /business/contract/subscription/close

- ##### 程式路徑:  newfoundation\OmsFoundationApi\TGOP.ServiceNode.OmsFoundationApi.ServiceCore\ApiService\ContractApiService.cs

- ##### 流程說明:

  1. ##### 傳入`baseContractSn` ，從`subscription_record`中取得最後一筆訂閱合約紀錄

  2. ##### 取得產品資訊

  3. ##### 最後一筆押上`is_Del`，這樣就不會產生下一期合約

  4. ##### 移除信用卡授權紀錄

     - ##### 呼叫28203 API: Subscription/DeleteAuth

     - ##### 程式路徑: 28203.payment.api\TutorGroup.Payment.API\Controllers\SubscriptionController.cs+

     - ##### 透過合約號(subscriptionSn)找到授權單，押上is_del



## 補充說明

- #### ISSUE

  - ##### 查詢訂閱單相關資料

    - ```sql
      SELECT * FROM payment.client_payment_record where contract_sn = 合約編號;
      
      SELECT * FROM payment.client_payment_detail where payrecord_sn = CPD.ID;	 
      select * from hitrust_record_all where order_number= 合約編號;
      
      SELECT * FROM subscription_auth WHERE subscription_sn = 合約編號
      
      SELECT * FROM subscription_auth_newebpay WHERE merchant_order_no= 特店訂單號
      
      SELECT * FROM subscription_record WHERE basc_contract_sn = 第一期合約編號
      ```

    - 



## 參考

- **[KM-訂閱制](http://tp-km.tutorabc.com/pages/viewpage.action?pageId=60292936&src=contextnavpagetreemode)**
- [04-2. 訂閱制](http://tp-km.tutorabc.com/pages/viewpage.action?pageId=68389922)
- [03. 排程](http://tp-km.tutorabc.com/pages/viewpage.action?pageId=68387217)



# 綠聯單生成

- ##### 程式路徑: 28206.Payment.FST-API\FstApi\TGOP.ServiceNode.FstApi.ServiceCore\ApiService\FstApiService_FstCommand.cs

- ###### API: /command/paperno

- #### 流程

  1. ##### 取得合約相關資訊(透過CPD.ID串聯)

     - ###### SQL Server資料庫`client_payment_detail` 

     - ###### SQL Server資料庫`client_payment_record` 

     - ###### SQL Server資料庫`client_temporal_contract` 

     - ###### SQL Server資料庫`cfg_product` 

  2. ##### 目前程式中僅針對在台灣的合約進行開單動作

  3. ##### 取得綠連單號

     - ###### 取得品牌資料(TutorABC、TutorABCJr)，透過合約內的`brandId`

       - 透過品牌取得尾碼(BrandCode)

     - ###### 取得CPD紀錄 (SQL Server資料庫client_payment_detail)

     - ###### 取得支付方資訊 (SQL Server資料庫CfgPayPlatform),透過CPD.StoreID

     - 前贅字處理(針對支付方的位置)

       - TW: MT

       - HK: HK

     - ###### 透過序號回CPD資料表取得最大號碼(paper_no)

       - ###### 序號產生方式:  $"{前贅字}{DateTime.Now.ToString("yyMMdd")}{步驟3.1 的值}"

       - ###### 如果有指定綠連單號 $"{preFix}{Convert.ToDateTime(paperNoDate).ToString("yyMMdd")}{result}"

       - ###### 到CPD中找出上述單號格式的最大單號值

     - ###### 回傳綠聯單號: 序號 + 最大單號+1

  4. ##### 更新CPD資料表(綠聯相關欄位)

     - ###### 更新MySQL跟SQL Server資料庫

     - ###### 更新SQL Server



# 發票流程

## 未開立發票查詢

- ### 程式路徑: .\FDProject\TutorGroup.FDInvoice\Controllers\ReceiptBatchOpenController.cs

- ### API路徑: ReceiptBatchOpen/GetReceiptBatchOpen

- ### 正式環境: http://tw.invoice.fdms.tutorabc.com/

- ### 流程說明

  1. ### 取得支付設定

     - ##### SQL Server 資料庫:TutorDefinition 資料表TutorDefinition.dbo.CfgPayPlatform

     - ##### 取得PayPlatFormCode、company_location欄位

  2. ### 取得未開票訂單相關資料

     - #####  batchOpenRepository.GetBatchOpenData(sDate, eDate);

     - ##### 查詢日期內訂單明細表

       - ###### SQL Server 資料庫:MuchnewDB資料表client_payment_detail

       - ###### 取得訂單明細內容

     - ##### 依據查詢出的DetailSn取得發票金額

       - ###### SQL Server 資料庫:MuchnewDB資料表client_invoice_record

     - ##### 移除已經開過發票且沒有作廢的訂單

       - ###### 針對查詢日的訂單透過`DetailSn` 對照所有發票清單

       - ###### 若發票總金額 > 0代表已經開立過發票

     - ##### 取得发票寄送信息資料

       - ###### MySQL 資料庫:payment 資料表client_invoice_info

       - ###### 透過剩餘未開票的訂單`PaymentDetailSn` 或 `ContractSn` 找尋相關資料

       - ###### 依據對應的資料調整訂單欄位內容

     - ##### 取得訂單內會員訊息

       - ###### 將訂單內會員清單透過 AP: I`http://stage.apitw.passport.tutorabc.com/web/customerKeyInfo/list` 取回會員資訊

       - ###### MemberService.GetMemberKeyInfoList(lst.Select(item => item.ClientSn).Distinct().ToList());

       - ###### 整併至訂單中

  3. ### 合併訂單

     1. ### 取得舊退費紀錄

        - ###### moneyBackRecordRepository.GetByContractSn(list.Where(d => !string.IsNullOrEmpty(d.ContractSn)) .Select(d => int.Parse(d.ContractSn)).Distinct().ToList());

        - ###### 透過訂單的ContractSn 找尋退費紀錄檔

        - ###### SQL Server 資料庫:MuchnewDB資料表client_money_back_record

     2. ### 取得退費主表

        - ###### refundRepository.GetByContractSn(list.Where(d => !string.IsNullOrEmpty(d.ContractSn)) .Select(d => int.Parse(d.ContractSn)).Distinct().ToList())

        - ###### 透過訂單的ContractSn 找尋退費紀錄檔

        - ###### SQL Server 資料庫:CNFI 資料表FDRefund

     3. ### 與訂單合併回傳

  4. ### 訂單處理

     1. ##### 檢查統一編號(InvoiceNum)

        - ###### 至商工行政平台取得統編資訊

        - ###### 判斷取回的公司名稱與发票抬头名稱是否相同

  5. ### 回傳查詢結果



## 發票開立

- #### 程式路徑: .\FDProject\TutorGroup.FDInvoice\Controllers\ReceiptBatchOpenController.cs

- #### 流程:

  1. #### 檢查發票開立日期

     1. ##### API路徑:  ReceiptBatchOpen/CheckReceiptOpenDate

     2. ##### 取得新的發票號碼

        - ##### RepositoryFactory.Common.GetReceiptNumber(Date, "1").ToString();

          - ##### 透過API: https://tw.fst-api.pay.tutorabc.com/invoice/invoice/generate_invoice_no ?invoiceDate=&invoiceType=

            - ###### Stage API: http://172.16.81.92:28233

            - ###### invoiceDate: 發票開立日期(前端傳入)

            - ###### invoiceType: 發票類型(紙本發票=1 ，電子發票 = 2)

     3. ##### 取得前一號發票資訊

        - ###### 目的: 確認新的發票日必須大於前一張發票日期

        - ###### SQL Server 資料庫:MuchnewDB資料表client_invoice_record

        - ###### 檢查取得的發票日期是否小於設定日期

  2. #### 開立發票

     1. ##### API路徑:  ReceiptBatchOpen/SetBatchOpen

     2. ##### 透過API: https://tw.fst-api.pay.tutorabc.com/invoice/invoice/add_batch_invoice進行發票開立

        - ###### Stage API: http://172.16.81.92:28233

     3. ##### 批次開票則

        

     ###### 

