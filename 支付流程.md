# 支付流程

1. ## 客戶端發起付款請求

   1. ##### 客戶端呼叫 API:  payment/program/member/{bank}/QuickPayService/SendToBank

      - ###### url:  {controller}/{program}/{member}/{bank}/{QuickPayService}/{SendToBank} 

      - ###### 對應PaymentController.Index

      - ###### bank: 支付方式

   2. ##### 依據指定支付方式取得支付設定內容

      - ###### 系統在啟動時會從資料庫內取得相關支付設定

        1. ###### 先至MySQL 資料庫:payment 資料表: cfg_pay_platform取得所有設定資料

        2. ###### 若MySQL沒有資料會再至 SQL Server 資料庫:muchnewdb 資料表TutorDefinition.dbo.CfgPayPlatform查詢

      - ###### 依據bank欄位取得對應的設定值

        - ###### CacheFactory.CfgPayPlatform.FirstOrDefault(a => a.EnumCode == RouteData.Values["bank"].ToString())

      - ##### WebSite對應國別

        - T: 台灣
        - C: 大陸
        - J: 日文

   3. ##### 檢察訂單內容

      - ###### PaymentVerifyHelper.CheckOrderInfo(paymentBankModel, lng)

      - ###### PaymentVerifyHelper.CheckSerialNumberAndPeriod(serialNumbers, lng)

   4. ##### 透過付款單序號取得訂單明細

      - ###### 先至MySQL取資料 (ContractRepository.GetClientContractInfoFromMysql)

        - ###### 合約包含主檔(付款紀錄表)及明細檔(訂單明細表)，透過client_payment_record.id 與 client_payment_detail.payrecord_sn串聯

      - ###### 若MySQL無資料，則至SQL Server取得 (ContractRepository.GetClientContractInfoFromSql)

   5. ##### 檢查合約內容

      1. ###### 判斷合約是否為null 或 是否合法(Valid)

      2. ###### 若沒有選擇幣別，則比較缴款金额是否相同

      3. ###### 若有填入幣別，則比較原幣金額(CurrencyAmount)

      4. ###### 判斷訂單是否已經付款過

      5. ###### 判斷付款方式是否包含在設定值(//23.台湾在线刷卡，34.在线支付，72.超商)

      6. ###### 錯誤訊息依據步驟2內的WebSite(T: 台灣, C: 大陸, J:日本)至PaymentVerifyHelper.GetDescription 取得對應訊息及語系

   6. ##### 點擊付款處理

      - ###### InsertToHiTrustRecordAllAndReturnSN(histrustRecordAll);

      - ###### 新增點擊支付紀錄: 

        - ###### MySQL資料至`hitrust_record_all` 並取得回傳sn序號

        - ###### 新增SQL Server資料`hitrust_record_all`

      - 更新訂單明細

        - ###### 更新MYSQL資料庫`client_payment_detail` id= PaymentDetailSn

        - ###### 更新SQL Server資料庫`client_payment_detail` sn= PaymentDetailSn

   7. ##### 呼叫28202取得支付設定內容

   

2. ## 系統至28202進行訂單處理

   1. ##### 建立支付請求表

      - ###### ServiceFactory.PayRequestService.AddPayRequest(requestData);

      - ###### MySQL 資料庫:payment 資料表: ms_payment_pay_request

      - ###### 並回傳ID

   2. ##### 建立支付歷史紀錄表

      - ###### ServiceFactory.PayHistoryService.Add(requestData, requestId);

      - ###### MySQL 資料庫:payment 資料表: ms_payment_pay_history

      - ###### 透過`requestID`與ms_payment_pay_request關聯

      - ###### PKey: serialNumber(自動增長序號)

      - ###### 如果OrderId欄位為空時，將serialNumber塞入OrderId欄位

      - ###### 回傳serialNumber

   3. ##### 取得支付設定檔

      - ###### 至MySQL資料庫 ms_payment_pay_config 

      - ###### 依據支付代號 `bank`取得設定檔內容

   4. ##### 驗證支付設定內容

      - ###### PayBankFactory.PaymentToBankService.Verify(requestData)

      - ###### 透過Factory的方式取得支付對應的涵式庫

      - ###### 路徑: .\TutorGroup.Payment.BankInterface\{支付方式}\Helps.cs

   5. ##### 建立支付回傳內容

      - ###### PayBankFactory.PaymentToBankService.BankRequest(requestData)

      - ###### 路徑: .\TutorGroup.Payment.BankInterface\{支付方式}\Helps.cs

      - ###### 依據步驟3 之設定檔(config_xml欄位)及各支付平台規範，建立回傳導頁內容

      - ###### config_xml: 為支付相關參數

        

3. ## 28202透過28203取得支付設定

   1. ##### 取得步驟2回傳的設定值

   2. ##### 回傳前端開始進行支付動作

   

4. ## 支付完成，呼叫28203進行Call back處理

   1. #### 金流支付完成後會呼叫28203指定URL(EX./PaymentPlatform/XXX/NotifyMsg)

      - ##### API路徑位置設定於Request內(ex.綠界route設定 .\TutorGroup.Payment.API\Models\ECPayNotifyRequest.cs)

      - ##### 支付Callback路徑在`.\TutorGroup.Payment.API\Payment\XXX.cs`(依據各支付平台切分)

   2. ### 通用流程

      1. ##### 回傳資料驗證(依據各支付平台)

         1. ##### 藍新

            1. ###### 判斷回傳的加密後`TradeInfo`是否與`TradeSha`相同

            2. ###### 將TradeInfor解密後取回資料

            3. ###### 判斷Status 是否為 Success

         2. ##### 綠界

            1. ##### 驗證FormData是否重複

               - ###### 透過系統常數儲存處理過的資料，並每次都進行判斷是否已經存在相同數據(避免支付成功重複發送)

               - ###### 系統設定站存10筆key值??

            2. ##### 回傳資料驗證

               - ###### 驗證`checkMacValue`與系統產生的`checkMacValue`(透過回傳的Key-Value，透過系統邏輯產生checkMacValue)

      2. ##### 新增支付Callback紀錄 `ServiceFactory.PayResponseService.Add`

         1. ##### 取得原始訂單資料的`SerialNumber`

            - ###### MySQL 資料庫:payment 資料表: ms_payment_pay_history  

            - ```sql
              select id ID,request_id RequestID,response_id ResponseID,success Success,bank Bank,message Message,
              order_sn OrderSn,serial_number SerialNumber,amount Amount,result_amount ResultAmount,request_date RequestDate,
              response_date ResponseDate,installment_times InstallmentTimes,order_id OrderId,app_id AppId,out_trade_no OutTradeNo,property_ex PropertyEx from ms_payment_pay_history 
              where order_id=@orderId; 
              ```

         2. ##### 新增支付Callback紀錄

            - ###### MySQL 資料庫:payment 資料表: ms_payment_pay_response

      3. ##### 透過SerialNumber取回支付紀錄 ServiceFactory.PayHistoryService.GetEfHistoryByOrderId(orderId);

      4. ##### 判斷history是否已經處理完成，若完成則直接回傳 

         - ###### 判斷交易紀錄的Success狀態、訊息、金額

      5. ##### 更新交易紀錄(`ServiceFactory.PayHistoryService.UpdatePayHistory(data, g)`)

         - ###### 更新資料庫payment 資料表: ms_payment_pay_history 

         - ###### 更新欄位Success、Message、ResultAmount、ResponseDate

         - ###### 依據serial_number找尋特定紀錄

      6. ##### 送通知到設定檔位置` HttpWebRequestHelper.SendResultToMerchantSite(data)`

      


# 各支付平台回傳導頁設定

## 綠界系統

- ```C#
  {
      //-----
  	var dict = new SortedDictionary<string, string>
      {
          //特店編號必填
          {"MerchantID", uniqueParameter.MerchantID},
          //特店訂單編號必填
          {"MerchantTradeNo", data.OrderId},
          //特店交易時間必填
          {"MerchantTradeDate", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss")},
          //交易類型 必填
          {"PaymentType", _config.PaymentType},
          //交易金額 必填
          {"TotalAmount", data.Amount.ToString()},
          //交易描述 必填
          {"TradeDesc", data.TradeDesc},
          //商品名稱 必填
          {"ItemName", data.ProductName},
          //付款完成通知回傳網址 必填
          {"ReturnURL", _config.ReturnURL},
          /*
          選擇預設付款方式
              Credit：信用卡及銀聯卡(需申請開通)
              WebATM：網路ATM
              ATM：自動櫃員機
              CVS：超商代碼
              BARCODE：超商條碼
              ApplePay: Apple Pay(僅支援手機支付)
              ALL：不指定付款方式，由綠界顯示付款方式選擇頁面。
          */
          {"ChoosePayment", _config.ChoosePayment},
          //{ "ClientBackURL", _config.ClientBackURL },
          //改为由调用方传入地址
          {"ClientBackURL", data.ResultURL},
          {"CreditInstallment", data.InstallmentTimes > 1 ? data.InstallmentTimes.ToString() : string.Empty},
          {"NeedExtraPaidInfo", _config.NeedExtraPaidInfo},
          //EncryptType  固定1
          {"EncryptType", "1"},
          {"Language", Language}
      };
  
      var sb = new StringBuilder();
      
      //GateWay: 綠界API位置
      sb.Append($"<form id=\"pay_form\" action=\"{_config.GateWay}\" method=\"post\">");
  
      //將上面設定的欄位帶入form data中,在Post時一併傳遞
      foreach (var item in dict)
      {
          sb.Append($"<input name=\"{item.Key}\" type=\"hidden\" value=\"{item.Value}\"/>");
      }
      // CheckMacValue 檢查碼 必填
      sb.Append($"<input name=\"CheckMacValue\" type=\"hidden\" value=\"{Signature(dict)}\"/>");
      sb.Append("</form>");
      sb.Append("<script language=\"javascript\">window.onload = function() {document.getElementById(\"pay_form\").submit();}</script>");
      return sb.ToString();
  }
  
  public string Signature(SortedDictionary<string, string> data)
  {
      var hashKey = _config.HashKey;
      var hashIv = _config.HashIV;
      var midName = "MerchantID";
  
      //绿界24期用专用的商户号
      if (data.ContainsKey(midName) && data[midName] == _config.Pay24PeriodConfig.MerchantID)
      {
          hashKey = _config.Pay24PeriodConfig.HashKey;
          hashIv = _config.Pay24PeriodConfig.HashIV;
      }
      else if ( data.ContainsKey( midName ) && data[midName] == _config.EscrowConfig.MerchantID) //綠界履約保證
      {
          hashKey = _config.EscrowConfig.HashKey;
          hashIv = _config.EscrowConfig.HashIV;
      }
  
      var text = $"HashKey={hashKey}&{string.Join("&", data.Select(a => a.Key + "=" + a.Value))}&HashIV={hashIv}";
  
      MongoLogHelper.Write($"绿界验签内容：{text}");
  
      return SHA256Crypto(text);
  }
  ```
  
  

# 資料表說明

1. ### cfg_pay_platform

   - | Field Name        | Data Type      | Description                                                  |
     | ----------------- | -------------- | ------------------------------------------------------------ |
     | id                | int(PK,AI)     |                                                              |
     | pay_mode_sn       | 付款方式       | client_payment_detail.payment_mode<br />[muchnewdb.dbo.cfg_pay_mode.sn](http://muchnewdb.dbo.cfg_pay_mode.sn/) |
     | pay_platform_code | 商店、平台id   | client_payment_detail.storeid                                |
     | pay_platform_name | 商店、平台名称 |                                                              |
     | ref_store_id      | 商店、平台id   | lient_payment_detail.storeid                                 |
     | sort              | int            |                                                              |
     | valid             | it             | 前端用以显示的值，数据逻辑不需要限定这个条件。               |
     | creator_id        | int            |                                                              |
     | created_at        | datetime       |                                                              |
     | cfg_store_sn      | nvarchar       |                                                              |
     | maximum_amount    | int            |                                                              |
     | minimal_amount    | int            |                                                              |
     | web_site          | nvarchar       |                                                              |
     | pay_type          | nvarchar       |                                                              |
     | image_name        | nvarchar       |                                                              |
     | enum_code         | nvarchar       | 英文代碼，對應API傳入bank                                    |
     | display_name      | nvarchar       |                                                              |
     | period            | nvarchar       |                                                              |
     | payment_code      | int            | 支付方式代碼(ex.41(綠界)，58(綠界分期))                      |
     | is_online_payment | int            |                                                              |
     | installment_type  | int            |                                                              |

   

2. ### ms_payment_pay_config

   | Field Name  | Data Type     | Description                                 |
   | ----------- | ------------- | ------------------------------------------- |
   | id          | int(11)       |                                             |
   | bank        | int(11)       | 支付代碼，對應cfg_pay_platform.payment_code |
   | config_type | int(11)       |                                             |
   | config_xml  | varchar(4000) | 支付方式設定內容                            |
   | code        | varchar(20)   |                                             |
   | dist        | varchar(10)   | 幣別                                        |
   | name        | varchar(20)   | 名稱                                        |
   | type        | tinyint(4)    |                                             |
   | period      | varchar(45)   | 分期設定                                    |
   | desc        | varchar(200)  | 說明                                        |
   | sort        | tinyint(4)    |                                             |
   | ex_property | varchar(2000) |                                             |

   

3. ### [其他支付相關資料表](http://tp-km.tutorabc.com/pages/viewpage.action?pageId=64247277)

   







